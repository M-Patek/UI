import React, { useState, useEffect, useRef } from 'react';
import { 
  Menu, 
  Plus, 
  Image as ImageIcon, 
  Mic, 
  Send, 
  Sparkles, 
  MoreVertical, 
  Settings, 
  HelpCircle,
  Code,
  ThumbsUp,
  ThumbsDown,
  Copy,
  RotateCcw,
  Check,
  X,
  Moon,
  Sun,
  MessageSquare,
  ExternalLink,
  Shield,
  Activity,
  Pin,
  Trash2,
  Edit2,
  MoreHorizontal,
  SquarePen,
  Search,
  Puzzle,
  Globe,
  Bell,
  CreditCard,
  Keyboard,
  FileQuestion,
  Info,
  ChevronDown,
  Terminal,
  CheckSquare,
  Square,
  Sigma
} from 'lucide-react';

// Custom CSS for animations and gradients
const customStyles = `
  @keyframes blob {
    0% { transform: translate(0px, 0px) scale(1); }
    33% { transform: translate(30px, -50px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    100% { transform: translate(0px, 0px) scale(1); }
  }
  .animate-blob {
    animation: blob 7s infinite;
  }
  .animation-delay-2000 {
    animation-delay: 2s;
  }
  .animation-delay-4000 {
    animation-delay: 4s;
  }
  
  /* Pop/Spring Animation */
  @keyframes popIn {
    0% { opacity: 0; transform: scale(0.9) translateY(10px); }
    60% { opacity: 1; transform: scale(1.05); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }
  .animate-pop {
    animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    opacity: 0;
  }

  /* NEW: Message Slide In From Left with Pop */
  @keyframes messageSlideIn {
    0% { opacity: 0; transform: translateX(-40px) scale(0.9); }
    60% { opacity: 1; transform: translateX(10px) scale(1.02); }
    100% { opacity: 1; transform: translateX(0) scale(1); }
  }
  .animate-message-slide-in {
    animation: messageSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    opacity: 0;
  }

  /* Slide In Left Animation for Sidebar Items */
  @keyframes slideInLeftPop {
    0% { opacity: 0; transform: translateX(-20px) scale(0.95); }
    60% { opacity: 1; transform: translateX(5px) scale(1.01); }
    100% { opacity: 1; transform: translateX(0) scale(1); }
  }
  .animate-slide-in-left {
    animation: slideInLeftPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    opacity: 0;
  }

  /* Modal Overlay Fade In */
  @keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .animate-fade-in {
    animation: fadeInOverlay 0.2s ease-out forwards;
  }

  /* Modal Overlay Fade Out */
  @keyframes fadeOutOverlay {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  .animate-fade-out {
    animation: fadeOutOverlay 0.2s ease-in forwards;
  }

  /* Modal Content Scale Up (Open) */
  @keyframes scaleUpModal {
    from { opacity: 0; transform: scale(0.95) translate(-50%, -48%); }
    to { opacity: 1; transform: scale(1) translate(-50%, -50%); }
  }
  .animate-modal {
    animation: scaleUpModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  /* Modal Content Scale Down (Close) */
  @keyframes scaleDownModal {
    from { opacity: 1; transform: scale(1) translate(-50%, -50%); }
    to { opacity: 0; transform: scale(0.95) translate(-50%, -48%); }
  }
  .animate-modal-out {
    animation: scaleDownModal 0.2s ease-in forwards;
  }

  /* Staggered delays */
  .delay-100 { animation-delay: 100ms; }
  .delay-200 { animation-delay: 200ms; }
  .delay-300 { animation-delay: 300ms; }
  .delay-400 { animation-delay: 400ms; }
  .delay-500 { animation-delay: 500ms; }

  .fade-in-text {
    animation: fadeIn 0.5s ease-out forwards;
    opacity: 0;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Toast Pop Animation */
  @keyframes slideUpPop {
    0% { opacity: 0; transform: translate(-50%, 20px) scale(0.9); }
    60% { opacity: 1; transform: translate(-50%, -5px) scale(1.05); }
    100% { opacity: 1; transform: translate(-50%, 0) scale(1); }
  }
  .toast-enter {
    animation: slideUpPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  /* Global Scrollbar Styling (Clean & Minimal) */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  ::-webkit-scrollbar-track {
    background: transparent; /* No background color for track */
  }
  ::-webkit-scrollbar-thumb {
    background: rgba(156, 163, 175, 0.5); /* Subtle gray thumb */
    border-radius: 10px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(156, 163, 175, 0.8);
  }
  /* Remove buttons (arrows) from all scrollbars */
  ::-webkit-scrollbar-button {
    display: none;
    width: 0;
    height: 0;
  }
  ::-webkit-scrollbar-corner {
    background: transparent;
  }

  /* Hide scrollbar utility class */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* iOS 26 Glassmorphism Utilities */
  .glass {
    background: rgba(255, 255, 255, 0.45);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
  }
  
  .glass-darker {
    background: rgba(255, 255, 255, 0.65);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
  }

  /* Header glass */
  .glass-header {
    background: rgba(255, 255, 255, 0.5); 
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.02);
  }
  
  .glass-sidebar {
    background: rgba(240, 244, 249, 0.3);
    backdrop-filter: blur(30px) saturate(150%);
    -webkit-backdrop-filter: blur(30px) saturate(150%);
    border-right: 1px solid rgba(255, 255, 255, 0.3);
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(12px) saturate(120%);
    -webkit-backdrop-filter: blur(12px) saturate(120%);
    border: 1px solid rgba(255, 255, 255, 0.5);
    transition: all 0.3s ease;
  }
  .glass-card:hover {
    background: rgba(255, 255, 255, 0.55);
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  .glass-input {
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
  }

  .glass-pill {
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(12px) saturate(120%);
    -webkit-backdrop-filter: blur(12px) saturate(120%);
    border: 1px solid rgba(255, 255, 255, 0.5);
    transition: all 0.2s ease;
  }
  .glass-pill:hover {
    background: rgba(255, 255, 255, 0.65);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  /* Enhanced menu glass for better layering */
  .glass-menu {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5);
  }

  .glass-bubble-user {
    background: rgba(231, 240, 254, 0.4);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.4);
  }
  
  .glass-code-header {
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  }

  /* Table Styles */
  .markdown-table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
    font-size: 0.875rem;
    overflow: hidden;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.1);
  }
  .markdown-table th {
    background-color: rgba(240, 244, 249, 0.5);
    font-weight: 600;
    text-align: left;
    padding: 12px;
    border-bottom: 2px solid rgba(0,0,0,0.1);
  }
  .markdown-table td {
    padding: 12px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  .markdown-table tr:last-child td {
    border-bottom: none;
  }
  .markdown-table tr:hover {
    background-color: rgba(255,255,255,0.4);
  }

  /* Markdown & Latex Styles */
  .markdown-blockquote {
    border-left: 4px solid #c084fc; /* FIXED: Light Purple Border */
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: #4b5563;
    background: rgba(192, 132, 252, 0.1); /* FIXED: Light Purple Background */
    padding: 0.5rem 1rem;
    border-radius: 0 8px 8px 0;
  }
  
  .task-list-item {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  /* Katex Font Fixes if CDN fails */
  .katex { font-size: 1.1em; }
  
  /* Make display math centered and scrollable if needed */
  .katex-display {
     overflow-x: auto;
     overflow-y: hidden;
     padding: 0.5em 0;
     margin: 1em 0;
  }
`;

// Helper Hooks to load external scripts for Highlighting and Math
const useExternalLib = () => {
  useEffect(() => {
    const loadStyle = (href) => {
      if (!document.querySelector(`link[href="${href}"]`)) {
        const link = document.createElement('link');
        link.href = href;
        link.rel = 'stylesheet';
        document.head.appendChild(link);
      }
    };

    const loadScript = (src) => {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve(); 
          return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = resolve;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    };

    const init = async () => {
      loadStyle('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css');
      loadStyle('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css');

      try {
        await Promise.all([
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js'),
          loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js')
        ]);

        await Promise.all([
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js'),
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js'),
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js'),
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js'),
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js'),
          loadScript('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js')
        ]);
      } catch (e) {
        console.error("Failed to load external libraries", e);
      }
    };

    init();
  }, []);
};

// Toast Notification Component
const Toast = ({ message, onClose }) => {
  useEffect(() => {
    if (!message) return;
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [message, onClose]);

  if (!message) return null;

  return (
    <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 glass-darker text-gray-800 px-4 py-3 rounded-2xl text-sm z-[100] toast-enter flex items-center gap-2 min-w-[200px] justify-center font-medium">
      <span>{message}</span>
    </div>
  );
};

// Modal Component
const Modal = ({ isOpen, onClose, title, children, isClosing }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center">
      <div 
        className={`absolute inset-0 bg-black/10 backdrop-blur-sm ${isClosing ? 'animate-fade-out' : 'animate-fade-in'}`}
        onClick={onClose}
      />
      <div className={`glass-darker rounded-[32px] w-[90%] max-w-md p-6 relative z-10 transform top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 ${isClosing ? 'animate-modal-out' : 'animate-modal'}`}>
        <div className="flex items-center justify-between mb-4 pb-2 border-b border-gray-200/50">
          <h2 className="text-xl font-medium text-gray-800">{title}</h2>
          <button onClick={onClose} className="p-2 hover:bg-gray-100/50 rounded-full transition-colors">
            <X className="w-5 h-5 text-gray-500" />
          </button>
        </div>
        <div className="max-h-[60vh] overflow-y-auto no-scrollbar">
          {children}
        </div>
      </div>
    </div>
  );
};

// Latex Renderer Component
const LatexRenderer = ({ content, displayMode = false }) => {
  const containerRef = useRef(null);
  
  useEffect(() => {
    if (window.katex && containerRef.current) {
      try {
        window.katex.render(content, containerRef.current, {
          displayMode: displayMode,
          throwOnError: false,
          output: 'html' 
        });
      } catch (e) {
        console.warn("Katex render error:", e);
        containerRef.current.innerText = content;
      }
    } else {
       containerRef.current.innerText = content;
    }
  }, [content, displayMode]);

  return <span ref={containerRef} className={displayMode ? "block my-4 w-full overflow-x-auto text-center" : "inline-block mx-0.5 align-middle"} />;
};

// Enhanced Code Canvas with Syntax Highlighting
const CodeCanvas = ({ language, code }) => {
  const [copied, setCopied] = useState(false);
  const codeRef = useRef(null);
  
  useEffect(() => {
    const highlight = () => {
      if (window.Prism && codeRef.current) {
        window.Prism.highlightElement(codeRef.current);
      }
    };

    if (window.Prism) {
      highlight();
    } else {
      const interval = setInterval(() => {
        if (window.Prism) {
          highlight();
          clearInterval(interval);
        }
      }, 500);
      return () => clearInterval(interval);
    }
  }, [code, language]);

  const handleCopy = () => {
    navigator.clipboard.writeText(code);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="my-4 rounded-xl overflow-hidden glass-card border border-white/40 shadow-sm group animate-pop">
      <div className="flex items-center justify-between px-4 py-2 glass-code-header bg-gray-50/50">
        <div className="flex items-center gap-2">
          <Terminal className="w-4 h-4 text-gray-500" />
          <span className="text-xs font-semibold text-gray-600 uppercase tracking-wide">{language || 'Code'}</span>
        </div>
        <button 
          onClick={handleCopy} 
          className="flex items-center gap-1.5 px-2 py-1 hover:bg-white/50 rounded-md transition-colors text-xs font-medium text-gray-600"
        >
          {copied ? (
            <>
              <Check className="w-3.5 h-3.5 text-green-600" />
              <span className="text-green-600">Copied</span>
            </>
          ) : (
            <>
              <Copy className="w-3.5 h-3.5" />
              <span>Copy</span>
            </>
          )}
        </button>
      </div>
      <div className="bg-[#2d2d2d] overflow-x-auto">
        <pre className="!m-0 !p-5 !bg-transparent" style={{ margin: 0 }}>
          <code 
            ref={codeRef} 
            className={`text-sm font-mono leading-relaxed text-gray-200 whitespace-pre language-${language || 'text'}`}
            style={{ fontFamily: 'Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace' }}
          >
            {code}
          </code>
        </pre>
      </div>
    </div>
  );
};

// Markdown Table Component - Now accepts a render function for cells
const MarkdownTable = ({ content, renderCell }) => {
  const rows = content.trim().split('\n').filter(row => row.trim() !== '');
  if (rows.length < 2) return <div className="whitespace-pre-wrap">{content}</div>;

  const headerRow = rows[0];
  const bodyRows = rows.slice(2);

  const parseRow = (row) => {
    return row.split('|').filter((cell, index, arr) => {
      if (index === 0 && cell.trim() === '') return false;
      if (index === arr.length - 1 && cell.trim() === '') return false;
      return true;
    }).map(cell => cell.trim());
  };

  const headers = parseRow(headerRow);
  if (!headerRow.includes('|')) return <div className="whitespace-pre-wrap">{content}</div>;

  return (
    <div className="overflow-x-auto my-4 rounded-xl border border-gray-200/50">
      <table className="markdown-table">
        <thead>
          <tr>
            {headers.map((header, i) => (
              <th key={i}>{header}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {bodyRows.map((row, i) => {
            if (row.match(/^[\s|:-]+$/)) return null;
            const cells = parseRow(row);
            return (
              <tr key={i}>
                {cells.map((cell, j) => (
                  // FIXED: Use renderCell function to support markdown inside tables
                  <td key={j}>{renderCell ? renderCell(cell) : cell}</td>
                ))}
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
};

// Input Area Component - Fixed Auto Height
const InputArea = ({ 
  input, 
  setInput, 
  onSend, 
  isCentered = false, 
  fileInputRef, 
  handleFileUpload,
  inputRef, 
  isListening, 
  toggleMic, 
  showModeMenu, 
  setShowModeMenu, 
  inputMode, 
  setInputMode, 
  modeMenuRef, 
  handleKeyDown
}) => {
  
  // FIXED: Auto-resize textarea
  useEffect(() => {
    if (inputRef.current) {
      inputRef.current.style.height = 'auto'; // Reset height
      // Limit to approx 6 lines (line-height ~24px * 6 = 144px)
      const newHeight = Math.min(inputRef.current.scrollHeight, 144);
      inputRef.current.style.height = `${newHeight}px`;
    }
  }, [input, inputRef]);

  return (
    <div className={`
      relative flex items-end gap-2 p-3 rounded-[32px] transition-all duration-300
      glass-input w-full
      ${isCentered ? 'shadow-lg' : ''}
    `}>
      <input 
        type="file" 
        ref={fileInputRef} 
        className="hidden" 
        onChange={handleFileUpload} 
        accept="image/*"
      />
      <button 
        onClick={() => fileInputRef.current?.click()}
        className="p-2 text-gray-600 hover:bg-gray-100/50 rounded-full transition-colors mb-0.5 tooltip"
        title="Upload image"
      >
        <ImageIcon className="w-6 h-6" />
      </button>

      <textarea
        ref={inputRef}
        value={input}
        onChange={(e) => setInput(e.target.value)}
        onKeyDown={handleKeyDown}
        placeholder="Enter a prompt here"
        className="w-full bg-transparent border-none outline-none resize-none text-base py-3 text-gray-800 placeholder-gray-500 overflow-y-auto"
        rows={1}
        style={{ minHeight: '48px', maxHeight: '144px' }}
      />

      <div className="flex items-center gap-1 mb-0.5">
        {input ? (
           <button 
            onClick={() => onSend()}
            className="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-colors animate-pop shadow-lg shadow-blue-500/30"
          >
            <Send className="w-5 h-5" />
          </button>
        ) : (
          <div className="flex items-center gap-2">
            <div className="relative" ref={modeMenuRef}>
              <button 
                onClick={() => setShowModeMenu(!showModeMenu)}
                className={`flex items-center gap-2 px-4 py-2 rounded-full transition-all text-sm font-medium border border-transparent ${showModeMenu ? 'bg-white/60 shadow-sm border-white/40' : 'hover:bg-white/40 text-gray-600'}`}
                title="Select Model"
              >
                <span className="text-gray-700">{inputMode}</span>
                <ChevronDown className={`w-4 h-4 text-gray-500 transition-transform ${showModeMenu ? 'rotate-180' : ''}`} />
              </button>
              
              {showModeMenu && (
                <div className="absolute bottom-full left-0 mb-2 w-80 glass-menu rounded-2xl p-2 z-50 animate-pop shadow-xl flex flex-col">
                  <div className="px-3 py-2 border-b border-gray-100/50 mb-1">
                    <span className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#4285F4] via-[#9B72CB] to-[#D96570]">Basile</span>
                  </div>
                  {[
                    { id: 'Fast', desc: 'Answers quickly' },
                    { id: 'Thinking', desc: 'Solving complex problems' },
                    { id: 'Pro', desc: 'Thinks longer for advanced math & code' }
                  ].map((mode) => (
                    <button
                      key={mode.id}
                      onClick={() => {
                        setInputMode(mode.id);
                        setShowModeMenu(false);
                      }}
                      className="flex items-center justify-between w-full p-3 hover:bg-white/60 rounded-xl text-left transition-colors group"
                    >
                      <div className="flex flex-col gap-0.5">
                        <span className="text-sm font-bold text-gray-800">{mode.id}</span>
                        <span className="text-xs text-gray-500 font-light group-hover:text-gray-600">{mode.desc}</span>
                      </div>
                      {inputMode === mode.id && <Check className="w-4 h-4 text-blue-600" />}
                    </button>
                  ))}
                </div>
              )}
            </div>

            <button 
              onClick={toggleMic}
              className={`p-2 rounded-full transition-colors ${isListening ? 'bg-red-100 text-red-600' : 'text-gray-600 hover:bg-gray-100/50'}`}
            >
              <Mic className={`w-6 h-6 ${isListening ? 'animate-pulse' : ''}`} />
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

const SettingsContent = () => {
  const [darkTheme, setDarkTheme] = useState(false);
  
  return (
    <div className="space-y-2">
      <div className="px-1 py-1">
        <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-2">Preferences</h3>
        <div 
          onClick={() => setDarkTheme(!darkTheme)}
          className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer"
        >
          <div className="flex items-center gap-3">
            {darkTheme ? <Moon className="w-5 h-5 text-blue-600" /> : <Sun className="w-5 h-5 text-gray-600" />}
            <span className="text-gray-700">Dark theme</span>
          </div>
          <div className={`w-10 h-6 rounded-full relative transition-colors ${darkTheme ? 'bg-blue-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow-sm transition-transform duration-200 ${darkTheme ? 'left-5' : 'left-1'}`} />
          </div>
        </div>

        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <Puzzle className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Extensions</span>
          </div>
          <ExternalLink className="w-4 h-4 text-gray-400" />
        </div>

        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <Globe className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Language</span>
          </div>
          <span className="text-sm text-gray-400">English (US)</span>
        </div>
      </div>

      <div className="border-t border-gray-200/50 my-2"></div>

      <div className="px-1 py-1">
        <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-2">Account</h3>
        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <Shield className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Public links</span>
          </div>
          <ExternalLink className="w-4 h-4 text-gray-400" />
        </div>
        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <CreditCard className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Subscription</span>
          </div>
        </div>
        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <Bell className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Notifications</span>
          </div>
        </div>
      </div>
    </div>
  );
};

const ActivityContent = () => (
  <div className="space-y-4">
    <div className="relative">
      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
      <input 
        type="text" 
        placeholder="Search your activity" 
        className="w-full bg-white/40 border-none rounded-full py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-blue-200 outline-none backdrop-blur-sm"
      />
    </div>

    <div>
      <div className="flex items-center justify-between mb-2">
        <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Today</p>
        <button className="text-xs text-blue-600 hover:underline">Clear day</button>
      </div>
      {[
        { title: "Explain React Hooks", time: "10:42 AM" },
        { title: "Draft an email to boss", time: "09:15 AM" }
      ].map((item, i) => (
        <div key={i} className="group flex items-start gap-3 p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <MessageSquare className="w-4 h-4 text-gray-400 mt-1 shrink-0" />
          <div className="flex-1 min-w-0">
            <p className="text-sm text-gray-800 truncate">{item.title}</p>
            <p className="text-xs text-gray-400 mt-0.5">{item.time} • Web</p>
          </div>
          <button className="opacity-0 group-hover:opacity-100 p-1 hover:bg-white/60 rounded-full text-gray-500 transition-all">
            <X className="w-3 h-3" />
          </button>
        </div>
      ))}
    </div>

    <div>
      <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Yesterday</p>
      {[
        { title: "Python script for data analysis", time: "4:20 PM" },
        { title: "Best sushi restaurants in Tokyo", time: "1:30 PM" }
      ].map((item, i) => (
        <div key={i} className="group flex items-start gap-3 p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <MessageSquare className="w-4 h-4 text-gray-400 mt-1 shrink-0" />
          <div className="flex-1 min-w-0">
            <p className="text-sm text-gray-800 truncate">{item.title}</p>
            <p className="text-xs text-gray-400 mt-0.5">{item.time} • Mobile</p>
          </div>
          <button className="opacity-0 group-hover:opacity-100 p-1 hover:bg-white/60 rounded-full text-gray-500 transition-all">
            <X className="w-3 h-3" />
          </button>
        </div>
      ))}
    </div>
  </div>
);

const HelpContent = () => (
  <div className="space-y-2">
    <div className="p-4 bg-blue-50/50 rounded-2xl mb-4 border border-blue-100/50">
      <h4 className="font-medium text-blue-800 mb-1">Gemini Advanced</h4>
      <p className="text-xs text-blue-600 mb-3">Get our most capable AI models and priority access to new features.</p>
      <button className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-full font-medium hover:bg-blue-700 transition-colors shadow-lg shadow-blue-600/20">
        Upgrade now
      </button>
    </div>

    {[
      { icon: HelpCircle, text: "Help Center" },
      { icon: Sparkles, text: "Updates & FAQ" },
      { icon: Keyboard, text: "Keyboard shortcuts" },
      { icon: FileQuestion, text: "Send feedback" },
      { icon: Info, text: "Privacy & Terms" }
    ].map((item, i) => (
      <div key={i} className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer group">
        <div className="flex items-center gap-3">
          <item.icon className="w-5 h-5 text-gray-500 group-hover:text-gray-700" />
          <span className="text-gray-700 group-hover:text-gray-900">{item.text}</span>
        </div>
        <ExternalLink className="w-4 h-4 text-gray-300 group-hover:text-gray-400" />
      </div>
    ))}
    
    <div className="mt-4 pt-4 border-t border-gray-200/50 text-center">
      <p className="text-xs text-gray-400">Version 2024.05.15</p>
    </div>
  </div>
);

const SidebarItem = ({ chat, onLoad, onPin, onRename, onDelete, index }) => {
  const [isEditing, setIsEditing] = useState(false);
  const [editTitle, setEditTitle] = useState(chat.title);
  const [showMenu, setShowMenu] = useState(false);
  const inputRef = useRef(null);
  const menuRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (menuRef.current && !menuRef.current.contains(event.target)) {
        setShowMenu(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleRenameSubmit = (e) => {
    e.preventDefault();
    if (editTitle.trim()) {
      onRename(chat.id, editTitle);
      setIsEditing(false);
      setShowMenu(false);
    }
  };

  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus();
    }
  }, [isEditing]);

  return (
    <div 
      className={`relative group animate-slide-in-left ${showMenu ? 'z-50' : 'z-auto'}`}
      style={{ animationDelay: `${(index + 1) * 50}ms` }}
    >
      {isEditing ? (
        <form onSubmit={handleRenameSubmit} className="px-2 py-1">
          <input
            ref={inputRef}
            type="text"
            value={editTitle}
            onChange={(e) => setEditTitle(e.target.value)}
            onBlur={() => { setIsEditing(false); setEditTitle(chat.title); }}
            className="w-full bg-white/50 border border-blue-500 rounded px-2 py-1 text-sm outline-none backdrop-blur-sm"
          />
        </form>
      ) : (
        <div 
          onClick={() => onLoad(chat.title)}
          className="w-full flex items-center justify-between hover:bg-white/40 px-4 py-2 rounded-full cursor-pointer transition-colors relative"
        >
          <div className="flex items-center gap-2 overflow-hidden flex-1">
            <span className={`text-sm text-gray-700 truncate ${chat.pinned ? 'font-medium' : ''}`}>{chat.title}</span>
            {chat.pinned && <Pin className="w-3.5 h-3.5 text-gray-400 fill-current shrink-0" />}
          </div>

          <div className="opacity-0 group-hover:opacity-100 transition-opacity absolute right-2">
            <button 
              onClick={(e) => { e.stopPropagation(); setShowMenu(!showMenu); }}
              className="p-1 hover:bg-white/50 rounded-full text-gray-600"
            >
              <MoreHorizontal className="w-4 h-4" />
            </button>
          </div>
        </div>
      )}

      {showMenu && !isEditing && (
        <div ref={menuRef} className="absolute right-0 top-8 z-50 w-36 glass-menu rounded-2xl shadow-2xl ring-1 ring-black/5 py-1 flex flex-col animate-fade-in">
           <button 
            onClick={(e) => { e.stopPropagation(); onPin(chat.id); setShowMenu(false); }}
            className="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-white/40 w-full text-left"
          >
            <Pin className="w-4 h-4" />
            {chat.pinned ? 'Unpin' : 'Pin'}
          </button>
          <button 
            onClick={(e) => { e.stopPropagation(); setIsEditing(true); }}
            className="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-white/40 w-full text-left"
          >
            <Edit2 className="w-4 h-4" />
            Rename
          </button>
          <button 
            onClick={(e) => { e.stopPropagation(); onDelete(chat.id); setShowMenu(false); }}
            className="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50/50 w-full text-left"
          >
            <Trash2 className="w-4 h-4" />
            Delete
          </button>
        </div>
      )}
    </div>
  );
};

const Sidebar = ({ isOpen, toggleSidebar, onNewChat, onLoadRecent, onOpenModal, chatHistory, setChatHistory }) => {
  const handlePin = (id) => {
    setChatHistory(prev => prev.map(chat => 
      chat.id === id ? { ...chat, pinned: !chat.pinned } : chat
    ).sort((a, b) => (b.pinned === a.pinned ? 0 : b.pinned ? 1 : -1)));
  };

  const handleDelete = (id) => {
    setChatHistory(prev => prev.filter(chat => chat.id !== id));
  };

  const handleRename = (id, newTitle) => {
    setChatHistory(prev => prev.map(chat => 
      chat.id === id ? { ...chat, title: newTitle } : chat
    ));
  };

  const sortedChats = [...chatHistory].sort((a, b) => Number(b.pinned) - Number(a.pinned));

  return (
    <div 
      className={`
        fixed inset-y-0 left-0 z-50 glass-sidebar flex flex-col shadow-2xl 
        transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)]
        w-72 transform
        ${isOpen ? 'translate-x-0' : '-translate-x-full'}
        lg:translate-x-0 lg:transform-none lg:shadow-none lg:relative
        ${isOpen ? 'lg:w-64 lg:opacity-100' : 'lg:w-0 lg:opacity-0 lg:overflow-hidden'}
      `}
    >
      <div 
        className={`
          w-72 lg:w-64 flex flex-col h-full min-w-[16rem] 
          transition-all duration-500 ease-out
          ${isOpen ? 'opacity-100 translate-x-0 scale-100 delay-100' : 'opacity-0 -translate-x-4 scale-95'}
        `}
      >
        <div className="p-4 flex items-center justify-between">
          <button onClick={toggleSidebar} className="p-2 hover:bg-white/40 rounded-full transition-colors">
            <Menu className="w-5 h-5 text-gray-600" />
          </button>
        </div>

        <div className="px-4 py-2">
          <button 
            key={isOpen ? 'newchat-open' : 'newchat-closed'}
            onClick={onNewChat}
            className={`w-full flex items-center space-x-3 glass-card text-gray-700 hover:text-[#041E49] px-4 py-3 rounded-2xl transition-all duration-200 whitespace-nowrap ${isOpen ? 'animate-pop delay-100' : ''}`}
          >
            <Plus className="w-5 h-5 shrink-0" />
            <span className="font-medium text-sm">New chat</span>
          </button>
        </div>

        <div className="flex-1 overflow-y-auto px-2 py-4 no-scrollbar">
          {/* FIXED: Removed variable key to prevent flickering */}
          <div key="recent-label" className={`text-xs font-medium text-gray-500 px-4 mb-2 ${isOpen ? 'animate-fade-in delay-200' : ''}`}>Recent</div>
          <div className="space-y-1 pb-10">
            {sortedChats.map((chat, idx) => (
              <SidebarItem 
                key={`${chat.id}-${isOpen}`}
                index={idx}
                chat={chat}
                onLoad={onLoadRecent}
                onPin={handlePin}
                onDelete={handleDelete}
                onRename={handleRename}
              />
            ))}
            {sortedChats.length === 0 && (
              <div className="px-4 text-sm text-gray-400 italic">No recent chats</div>
            )}
          </div>
        </div>

        <div className="p-2 mt-auto border-t border-white/20">
          <button 
            onClick={() => onOpenModal('help')}
            className="w-full flex items-center space-x-3 hover:bg-white/40 px-4 py-2.5 rounded-full text-left transition-colors whitespace-nowrap"
          >
            <HelpCircle className="w-5 h-5 text-gray-600 shrink-0" />
            <span className="text-sm text-gray-700">Help</span>
          </button>
          <button 
            onClick={() => onOpenModal('activity')}
            className="w-full flex items-center space-x-3 hover:bg-white/40 px-4 py-2.5 rounded-full text-left transition-colors whitespace-nowrap"
          >
            <Activity className="w-5 h-5 text-gray-600 shrink-0" />
            <span className="text-sm text-gray-700">Activity</span>
          </button>
          <button 
            onClick={() => onOpenModal('settings')}
            className="w-full flex items-center space-x-3 hover:bg-white/40 px-4 py-2.5 rounded-full text-left transition-colors whitespace-nowrap"
          >
            <Settings className="w-5 h-5 text-gray-600 shrink-0" />
            <span className="text-sm text-gray-700">Settings</span>
          </button>
        </div>
      </div>
    </div>
  );
};

const UserMessage = ({ content, delay = 0 }) => (
  <div 
    className="flex justify-end mb-8 animate-message-slide-in"
    style={{ animationDelay: `${delay}ms` }}
  >
    <div className="glass-bubble-user text-[#1F1F1F] px-5 py-3 rounded-2xl rounded-tr-sm max-w-[80%] md:max-w-[70%] leading-relaxed whitespace-pre-wrap shadow-sm">
      {content}
    </div>
  </div>
);

// Updated AIMessage with Robust Parser for MD, LaTeX, Code
const AIMessage = ({ content, isTyping, onShowToast, delay = 0 }) => {
  const [liked, setLiked] = useState(false);
  const [disliked, setDisliked] = useState(false);

  const handleCopy = () => {
    try {
      const textArea = document.createElement("textarea");
      textArea.value = content;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      onShowToast("Response copied to clipboard");
    } catch (e) {
      onShowToast("Failed to copy");
    }
  };

  const handleLike = () => {
    setLiked(!liked);
    setDisliked(false);
    if (!liked) onShowToast("Thanks for the feedback!");
  };

  const handleDislike = () => {
    setDisliked(!disliked);
    setLiked(false);
    if (!disliked) onShowToast("Thanks for the feedback!");
  };

  // Helper to parse Inline Formatting (Bold, Italic, Code, Math, Link)
  // FIXED: Now supports recursion for nested elements (e.g. bold code)
  const parseInline = (text) => {
    // Regex splits: Math -> Code -> Link -> Bold -> Italic
    const parts = text.split(/(\$[^$]+\$|`[^`]+`|\[.*?\]\(.*?\)|(\*\*|__).*?(\*\*|__)|\*.*?\*)/g);
    
    return parts.map((part, i) => {
      if (!part) return null;

      if (part.startsWith('$') && part.endsWith('$')) {
        return <LatexRenderer key={i} content={part.slice(1, -1)} displayMode={false} />;
      }
      if (part.startsWith('`') && part.endsWith('`')) {
        return <code key={i} className="bg-purple-50 text-purple-600 border border-purple-200 px-1.5 py-0.5 rounded text-sm font-mono">{part.slice(1, -1)}</code>;
      }
      if (part.startsWith('[') && part.includes('](')) {
        const match = part.match(/^\[(.*?)\]\((.*?)\)$/);
        if (match) {
           return <a key={i} href={match[2]} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">{match[1]}</a>;
        }
      }
      if (part.startsWith('**') || part.startsWith('__')) {
        // FIXED: Recursively parse content inside bold
        return <strong key={i} className="font-bold text-gray-900">{parseInline(part.slice(2, -2))}</strong>;
      }
      if (part.startsWith('*')) {
        // FIXED: Recursively parse content inside italic
        return <em key={i} className="italic text-gray-800">{parseInline(part.slice(1, -1))}</em>;
      }
      
      return part;
    });
  };

  const renderContent = (text) => {
    if (!text) return null;

    // Split text into segments: Code Blocks -> Math Blocks -> Text
    const parts = text.split(/(```[\s\S]*?```|\$\$[\s\S]*?\$\$)/g);

    return parts.map((part, index) => {
      // 1. Code Blocks
      if (part.startsWith('```') && part.endsWith('```')) {
        const match = part.match(/^```(\w+)?\n([\s\S]*?)```$/);
        if (match) {
          const language = match[1] || 'text';
          const code = match[2];
          return <CodeCanvas key={index} language={language} code={code} />;
        }
      }
      
      // 2. Math Blocks
      if (part.startsWith('$$') && part.endsWith('$$')) {
        const math = part.slice(2, -2).trim();
        return <LatexRenderer key={index} content={math} displayMode={true} />;
      }

      // 3. Process Regular Text (Inline Math, Markdown, etc.)
      return renderTextSegment(part, index);
    });
  };

  const renderTextSegment = (text, parentIndex) => {
    // Split by lines to handle block elements like lists/headers
    const lines = text.split('\n');
    const elements = [];
    let currentTableBuffer = [];
    let inTable = false;

    lines.forEach((line, lineIdx) => {
      const isTableLine = line.trim().startsWith('|') && line.trim().endsWith('|');
      const isSeparator = line.trim() === '---';
      const isTaskList = line.trim().match(/^- \[(x| )\] (.*)$/);
      const isHeader = line.trim().match(/^(#{1,6})\s(.*)$/);
      const isBlockquote = line.trim().startsWith('> ');
      const isBullet = line.trim().startsWith('* ') || line.trim().startsWith('- ');

      // Table Handling
      if (isTableLine) {
        currentTableBuffer.push(line);
        inTable = true;
        return; // Skip rest of loop
      } else if (inTable) {
        // Flush table
        elements.push(
          <MarkdownTable 
            key={`${parentIndex}-table-${lineIdx}`} 
            content={currentTableBuffer.join('\n')} 
            renderCell={parseInline} // Pass parseInline to table
          />
        );
        currentTableBuffer = [];
        inTable = false;
      }

      const key = `${parentIndex}-${lineIdx}`;

      if (isSeparator) {
        elements.push(<div key={key} className="h-px bg-gray-300/50 my-4" />);
      } else if (isTaskList) {
        const checked = isTaskList[1] === 'x';
        const content = isTaskList[2];
        elements.push(
          <div key={key} className="task-list-item text-gray-700">
            <div className="mt-1">
              {checked ? <CheckSquare className="w-4 h-4 text-blue-600" /> : <Square className="w-4 h-4 text-gray-400" />}
            </div>
            <div className="flex-1">{parseInline(content)}</div>
          </div>
        );
      } else if (isHeader) {
        const level = isHeader[1].length;
        const content = isHeader[2];
        const sizes = { 1: 'text-2xl', 2: 'text-xl', 3: 'text-lg', 4: 'text-base', 5: 'text-sm', 6: 'text-xs' };
        elements.push(
          <div key={key} className={`font-bold text-gray-800 mt-4 mb-2 ${sizes[level] || 'text-base'}`}>
            {parseInline(content)}
          </div>
        );
      } else if (isBlockquote) {
        elements.push(
          <div key={key} className="markdown-blockquote">
            {parseInline(line.replace(/^> /, ''))}
          </div>
        );
      } else if (isBullet) {
        elements.push(
          <div key={key} className="flex items-start gap-2 mb-1 ml-1">
            <span className="text-gray-400 mt-1.5 text-[0.6rem]">•</span>
            <div className="whitespace-pre-wrap flex-1">{parseInline(line.replace(/^[* -]\s+/, ''))}</div>
          </div>
        );
      } else if (line.trim() !== '') {
        elements.push(
          <div key={key} className="whitespace-pre-wrap mb-1">
            {parseInline(line)}
          </div>
        );
      }
    });

    // Flush remaining table
    if (currentTableBuffer.length > 0) {
      elements.push(
        <MarkdownTable 
          key={`${parentIndex}-table-end`} 
          content={currentTableBuffer.join('\n')} 
          renderCell={parseInline}
        />
      );
    }

    return <div key={`text-${parentIndex}`}>{elements}</div>;
  };

  return (
    <div 
      className="flex items-start space-x-4 mb-8 group animate-message-slide-in"
      style={{ animationDelay: `${delay}ms` }}
    >
      <div className="flex-shrink-0 mt-1">
        <div className="w-8 h-8 rounded-full overflow-hidden flex items-center justify-center bg-gradient-to-tr from-[#4285F4] to-[#9B72CB] shadow-md">
          <Sparkles className="w-5 h-5 text-white animate-pulse" />
        </div>
      </div>
      <div className="flex-1 space-y-2 min-w-0">
        <div className="font-medium text-sm text-gray-900">Basile</div>
        
        <div className="prose prose-slate max-w-none text-[#1F1F1F] leading-7 fade-in-text">
          {renderContent(content)}
        </div>
        
        {!isTyping && (
          <div className="flex items-center space-x-1 pt-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
            <button 
              onClick={handleLike}
              className={`p-1.5 hover:bg-white/50 rounded-full transition-colors ${liked ? 'text-blue-600' : 'text-gray-500'}`} 
            >
              <ThumbsUp className={`w-4 h-4 ${liked ? 'fill-current' : ''}`} />
            </button>
            <button 
              onClick={handleDislike}
              className={`p-1.5 hover:bg-white/50 rounded-full transition-colors ${disliked ? 'text-red-500' : 'text-gray-500'}`}
            >
              <ThumbsDown className={`w-4 h-4 ${disliked ? 'fill-current' : ''}`} />
            </button>
            <button 
              onClick={handleCopy}
              className="p-1.5 hover:bg-white/50 rounded-full text-gray-500 transition-colors"
            >
              <Copy className="w-4 h-4" />
            </button>
            <button className="p-1.5 hover:bg-white/50 rounded-full text-gray-500 transition-colors">
              <RotateCcw className="w-4 h-4" />
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default function App() {
  // Load external scripts (Prism, Katex)
  useExternalLib();

  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const [isTyping, setIsTyping] = useState(false);
  const [toastMsg, setToastMsg] = useState('');
  const [isListening, setIsListening] = useState(false);
  const [activeModal, setActiveModal] = useState(null);
  const [isModalClosing, setIsModalClosing] = useState(false);
  const [conversationId, setConversationId] = useState(0); 
  const [inputMode, setInputMode] = useState('Fast');
  const [showModeMenu, setShowModeMenu] = useState(false);
  
  const [chatHistory, setChatHistory] = useState([
    { id: 1, title: "React UI Design Patterns", pinned: false },
    { id: 2, title: "Material 3 Specifications", pinned: true },
    { id: 3, title: "Tailwind Animation Guide", pinned: false },
    { id: 4, title: "Frontend Architecture", pinned: false },
    { id: 5, title: "Understanding CSS Grid", pinned: false },
    { id: 6, title: "Next.js vs Remix", pinned: false },
  ]);

  const scrollContainerRef = useRef(null);
  const shouldAutoScrollRef = useRef(true);
  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);
  const fileInputRef = useRef(null);
  const modeMenuRef = useRef(null);

  const scrollToBottom = () => {
    if (shouldAutoScrollRef.current) {
       messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }
  };

  const handleScroll = () => {
    if (scrollContainerRef.current) {
      const { scrollTop, scrollHeight, clientHeight } = scrollContainerRef.current;
      const isAtBottom = scrollHeight - scrollTop - clientHeight < 50;
      shouldAutoScrollRef.current = isAtBottom;
    }
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isTyping]);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (modeMenuRef.current && !modeMenuRef.current.contains(event.target)) {
        setShowModeMenu(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const showToast = (msg) => {
    setToastMsg(msg);
  };

  const handleCloseModal = () => {
    setIsModalClosing(true);
    setTimeout(() => {
      setActiveModal(null);
      setIsModalClosing(false);
    }, 200);
  };

  const handleSend = async (text = input) => {
    if (!text.trim()) return;

    shouldAutoScrollRef.current = true;

    const userMsg = {
      id: Date.now(),
      role: 'user',
      content: text
    };

    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsTyping(true);

    try {
      const apiKey = "";
      const history = messages.map(msg => ({
        role: msg.role === 'user' ? 'user' : 'model',
        parts: [{ text: msg.content }]
      }));

      const apiContents = [
        ...history,
        { role: 'user', parts: [{ text: text }] }
      ];

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: apiContents,
          })
        }
      );

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = await response.json();
      const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";

      const aiMsgId = Date.now() + 1;
      const aiMsg = {
        id: aiMsgId,
        role: 'ai',
        content: ''
      };
      setMessages(prev => [...prev, aiMsg]);

      let i = 0;
      const streamInterval = setInterval(() => {
        if (i < aiResponseText.length) {
          setMessages(prev => prev.map(msg => 
            msg.id === aiMsgId 
              ? { ...msg, content: aiResponseText.substring(0, i + 1) } 
              : msg
          ));
          i++;
        } else {
          clearInterval(streamInterval);
          setIsTyping(false);
        }
      }, 10);

    } catch (error) {
      console.error("Gemini API Error:", error);
      showToast("Error connecting to Gemini API");
      
      const errorMsg = {
        id: Date.now() + 1,
        role: 'ai',
        content: "I'm sorry, I'm having trouble connecting to my brain right now. Please try again later."
      };
      setMessages(prev => [...prev, errorMsg]);
      setIsTyping(false);
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const handleNewChat = () => {
    setMessages([]); 
    setIsTyping(false);
    setInput('');
    setConversationId(Date.now());
    if (window.innerWidth < 1024) setIsSidebarOpen(false);
  };

  const handleLoadRecent = (topic) => {
    setIsTyping(false);
    setConversationId(Date.now());
    setMessages([
      { id: 1, role: 'user', content: `Show me ${topic} features` },
      { id: 2, role: 'ai', content: `Here is a demo of the new rendering capabilities:\n\n### 1. Math Formulas (LaTeX)\n\nInline: $E = mc^2$\nBlock:\n$$\n\\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}\n$$\n\n### 2. Code with Highlighting\n\n\`\`\`python\ndef hello_world():\n    print("Hello from PrismJS!")\n    return True\n\`\`\`\n\n### 3. Task Lists\n\n- [x] Implement Markdown\n- [x] Add Syntax Highlighting\n- [ ] Create World Peace\n\n> "This is a blockquote to show off the styling."\n\nCheck the **source code** for implementation details!` }
    ]);
    if (window.innerWidth < 1024) setIsSidebarOpen(false);
  };

  const handleSuggestionClick = (suggestion) => {
    handleSend(suggestion);
  };

  const handleFileUpload = (e) => {
    if (e.target.files && e.target.files[0]) {
      showToast(`Image "${e.target.files[0].name}" attached`);
    }
  };

  const toggleMic = () => {
    if (!isListening) {
      setIsListening(true);
      showToast("Listening...");
      setTimeout(() => {
        setIsListening(false);
        setInput("Describe the theory of relativity using math.");
      }, 2000);
    } else {
      setIsListening(false);
    }
  };

  return (
    <div className="relative flex h-screen font-sans overflow-hidden text-[#1F1F1F] selection:bg-[#c2dbfe] selection:text-[#0b57d0] bg-[#F8F9FA]">
      <style>{customStyles}</style>

      <div className="absolute inset-0 overflow-hidden pointer-events-none z-0 opacity-40">
        <div className="absolute top-0 left-1/4 w-[800px] h-[800px] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div className="absolute top-0 right-1/4 w-[800px] h-[800px] bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        <div className="absolute -bottom-8 left-1/3 w-[800px] h-[800px] bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
      </div>

      <Toast message={toastMsg} onClose={() => setToastMsg('')} />

      <Modal 
        isOpen={!!activeModal} 
        onClose={handleCloseModal} 
        title={activeModal === 'settings' ? 'Settings' : activeModal === 'activity' ? 'Gemini Activity' : 'Help'}
        isClosing={isModalClosing}
      >
        {activeModal === 'settings' ? <SettingsContent /> : activeModal === 'activity' ? <ActivityContent /> : <HelpContent />}
      </Modal>

      <Sidebar 
        isOpen={isSidebarOpen} 
        toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)} 
        onNewChat={handleNewChat}
        onLoadRecent={handleLoadRecent}
        onOpenModal={setActiveModal}
        chatHistory={chatHistory}
        setChatHistory={setChatHistory}
      />

      <div className="flex-1 flex flex-col h-full relative z-10">
        <div className="flex items-center justify-between px-5 py-3 glass-header sticky top-0 z-20">
          <div className="flex items-center space-x-2">
            <div className={`overflow-hidden transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] ${!isSidebarOpen ? 'w-10 opacity-100 mr-2' : 'w-0 opacity-0 mr-0'}`}>
              <button onClick={() => setIsSidebarOpen(true)} className="p-2 hover:bg-white/50 rounded-full transition-colors whitespace-nowrap">
                <Menu className="w-5 h-5 text-gray-600" />
              </button>
            </div>
            
            <button onClick={handleNewChat} className="p-2 hover:bg-white/50 rounded-full transition-colors mr-2 text-gray-600" title="New Chat">
              <SquarePen className="w-5 h-5" />
            </button>

            <button className="flex items-center space-x-1 text-lg font-medium text-gray-600 hover:bg-white/50 px-3 py-1.5 rounded-lg transition-colors">
              <span className="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#4285F4] via-[#9B72CB] to-[#D96570]">Basile</span>
              <MoreVertical className="w-4 h-4 ml-1 text-gray-400" />
            </button>
          </div>
          <div className="flex items-center space-x-2">
             <button onClick={() => setActiveModal('settings')} className="p-2 hover:bg-white/50 rounded-full transition-colors hidden sm:block">
                <Settings className="w-5 h-5 text-gray-600" />
             </button>
             <div className="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm font-medium cursor-pointer hover:ring-4 hover:ring-purple-100 transition-all shadow-lg shadow-purple-200">U</div>
          </div>
        </div>

        <div ref={scrollContainerRef} onScroll={handleScroll} className="flex-1 overflow-y-auto relative no-scrollbar">
          <div key={conversationId} className="h-full">
            {messages.length === 0 ? (
               <div className="flex flex-col items-center justify-center h-full max-w-[800px] mx-auto px-4 animate-pop">
                  <div className="w-full max-w-3xl mb-6">
                    <span className="text-3xl font-medium bg-clip-text text-transparent bg-gradient-to-r from-[#4285F4] to-[#9B72CB] block text-left">
                      Hello, User
                    </span>
                    <span className="text-3xl font-medium text-[#939699] block text-left mt-1">
                      How can I help today?
                    </span>
                  </div>

                  <div className="w-full max-w-3xl mb-8">
                    <InputArea 
                      input={input}
                      setInput={setInput}
                      onSend={handleSend}
                      isCentered={true}
                      fileInputRef={fileInputRef}
                      handleFileUpload={handleFileUpload}
                      inputRef={inputRef}
                      isListening={isListening}
                      toggleMic={toggleMic}
                      showModeMenu={showModeMenu}
                      setShowModeMenu={setShowModeMenu}
                      inputMode={inputMode}
                      setInputMode={setInputMode}
                      modeMenuRef={modeMenuRef}
                      handleKeyDown={handleKeyDown}
                    />
                  </div>

                  <div className="flex flex-wrap gap-3 justify-center w-full max-w-4xl px-4">
                     {[
                        { text: 'Explain React Hooks', icon: Code },
                        { text: 'Solve Quadratic Equation', icon: Sigma },
                        { text: 'Write a Python Script', icon: Terminal },
                        { text: 'Plan a trip', icon: Sparkles }
                     ].map((item, i) => (
                       <button 
                        key={i} 
                        onClick={() => handleSuggestionClick(item.text)}
                        className={`glass-pill px-5 py-2.5 rounded-full flex items-center gap-2 text-sm font-medium text-gray-700 animate-pop delay-${(i+1)*100}`}
                      >
                          {item.icon === Terminal ? <Terminal className="w-4 h-4 text-gray-500" /> : 
                           item.icon === Code ? <Code className="w-4 h-4 text-gray-500" /> :
                           item.icon === Sigma ? <Sigma className="w-4 h-4 text-gray-500" /> :
                           <Sparkles className="w-4 h-4 text-gray-500" />}
                          <span>{item.text}</span>
                       </button>
                     ))}
                  </div>
               </div>
            ) : (
              <div className="max-w-[800px] mx-auto px-4 pb-32 pt-10">
                {messages.map((msg, index) => (
                  msg.role === 'user' ? 
                  <UserMessage key={msg.id} content={msg.content} delay={index * 100} /> : 
                  <AIMessage 
                    key={msg.id} 
                    content={msg.content} 
                    isTyping={isTyping && msg.id === messages[messages.length-1].id} 
                    onShowToast={showToast} 
                    delay={index * 100}
                  />
                ))}
                <div ref={messagesEndRef} />
              </div>
            )}
          </div>
        </div>

        {messages.length > 0 && (
          <div className="absolute bottom-0 left-0 right-0 pt-10 pb-6 bg-gradient-to-t from-[#F8F9FA]/80 via-[#F8F9FA]/40 to-transparent pointer-events-none animate-fade-in">
            <div className="max-w-[800px] mx-auto px-4 pointer-events-auto">
              <InputArea 
                input={input}
                setInput={setInput}
                onSend={handleSend}
                fileInputRef={fileInputRef}
                handleFileUpload={handleFileUpload}
                inputRef={inputRef}
                isListening={isListening}
                toggleMic={toggleMic}
                showModeMenu={showModeMenu}
                setShowModeMenu={setShowModeMenu}
                inputMode={inputMode}
                setInputMode={setInputMode}
                modeMenuRef={modeMenuRef}
                handleKeyDown={handleKeyDown}
              />
              <div className="text-center mt-3">
                <p className="text-xs text-gray-500">
                  Gemini may display inaccurate info, including about people, so double-check its responses. 
                  <a href="#" className="underline ml-1">Your privacy and Gemini Apps</a>
                </p>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
