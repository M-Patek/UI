import React, { useState, useEffect, useRef } from 'react';
import { 
  Menu, 
  Plus, 
  Image as ImageIcon, 
  Mic, 
  Send, 
  Sparkles, 
  MoreVertical, 
  History, 
  Settings, 
  HelpCircle,
  Code,
  ThumbsUp,
  ThumbsDown,
  Copy,
  RotateCcw,
  Check,
  X,
  Moon,
  Sun,
  MessageSquare,
  ExternalLink,
  Shield,
  Activity,
  Pin,
  Trash2,
  Edit2,
  MoreHorizontal,
  SquarePen,
  Search,
  Puzzle,
  Globe,
  Bell,
  CreditCard,
  Keyboard,
  FileQuestion,
  Info
} from 'lucide-react';

// Custom CSS for animations and gradients
const customStyles = `
  @keyframes blob {
    0% { transform: translate(0px, 0px) scale(1); }
    33% { transform: translate(30px, -50px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    100% { transform: translate(0px, 0px) scale(1); }
  }
  .animate-blob {
    animation: blob 7s infinite;
  }
  .animation-delay-2000 {
    animation-delay: 2s;
  }
  .animation-delay-4000 {
    animation-delay: 4s;
  }
  
  /* Pop/Spring Animation */
  @keyframes popIn {
    0% { opacity: 0; transform: scale(0.9) translateY(10px); }
    60% { opacity: 1; transform: scale(1.05); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }
  .animate-pop {
    animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    opacity: 0;
  }

  /* NEW: Message Slide In From Left with Pop */
  @keyframes messageSlideIn {
    0% { opacity: 0; transform: translateX(-40px) scale(0.9); }
    60% { opacity: 1; transform: translateX(10px) scale(1.02); }
    100% { opacity: 1; transform: translateX(0) scale(1); }
  }
  .animate-message-slide-in {
    animation: messageSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    opacity: 0;
  }

  /* Slide In Left Animation for Sidebar Items */
  @keyframes slideInLeftPop {
    0% { opacity: 0; transform: translateX(-20px) scale(0.95); }
    60% { opacity: 1; transform: translateX(5px) scale(1.01); }
    100% { opacity: 1; transform: translateX(0) scale(1); }
  }
  .animate-slide-in-left {
    animation: slideInLeftPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    opacity: 0;
  }

  /* Modal Overlay Fade */
  @keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .animate-fade-in {
    animation: fadeInOverlay 0.2s ease-out forwards;
  }

  /* Modal Content Scale Up */
  @keyframes scaleUpModal {
    from { opacity: 0; transform: scale(0.95) translate(-50%, -48%); }
    to { opacity: 1; transform: scale(1) translate(-50%, -50%); }
  }
  .animate-modal {
    animation: scaleUpModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  /* Staggered delays */
  .delay-100 { animation-delay: 100ms; }
  .delay-200 { animation-delay: 200ms; }
  .delay-300 { animation-delay: 300ms; }
  .delay-400 { animation-delay: 400ms; }
  .delay-500 { animation-delay: 500ms; }

  .fade-in-text {
    animation: fadeIn 0.5s ease-out forwards;
    opacity: 0;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Toast Pop Animation */
  @keyframes slideUpPop {
    0% { opacity: 0; transform: translate(-50%, 20px) scale(0.9); }
    60% { opacity: 1; transform: translate(-50%, -5px) scale(1.05); }
    100% { opacity: 1; transform: translate(-50%, 0) scale(1); }
  }
  .toast-enter {
    animation: slideUpPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  /* Hide scrollbar */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* iOS 26 Glassmorphism Utilities */
  .glass {
    background: rgba(255, 255, 255, 0.45);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
  }
  
  .glass-darker {
    background: rgba(255, 255, 255, 0.65);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
  }
  
  .glass-sidebar {
    background: rgba(240, 244, 249, 0.3);
    backdrop-filter: blur(30px) saturate(150%);
    -webkit-backdrop-filter: blur(30px) saturate(150%);
    border-right: 1px solid rgba(255, 255, 255, 0.3);
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(12px) saturate(120%);
    -webkit-backdrop-filter: blur(12px) saturate(120%);
    border: 1px solid rgba(255, 255, 255, 0.5);
    transition: all 0.3s ease;
  }
  .glass-card:hover {
    background: rgba(255, 255, 255, 0.55);
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  .glass-input {
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
  }

  .glass-bubble-user {
    background: rgba(231, 240, 254, 0.4);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.4);
  }
`;

// Toast Notification Component
const Toast = ({ message, onClose }) => {
  useEffect(() => {
    if (!message) return;
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [message, onClose]);

  if (!message) return null;

  return (
    <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 glass-darker text-gray-800 px-4 py-3 rounded-2xl text-sm z-[100] toast-enter flex items-center gap-2 min-w-[200px] justify-center font-medium">
      <span>{message}</span>
    </div>
  );
};

// Modal Component
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-black/10 backdrop-blur-sm animate-fade-in"
        onClick={onClose}
      />
      
      {/* Content */}
      <div className="glass-darker rounded-[32px] w-[90%] max-w-md p-6 relative z-10 animate-modal transform top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
        <div className="flex items-center justify-between mb-4 pb-2 border-b border-gray-200/50">
          <h2 className="text-xl font-medium text-gray-800">{title}</h2>
          <button onClick={onClose} className="p-2 hover:bg-gray-100/50 rounded-full transition-colors">
            <X className="w-5 h-5 text-gray-500" />
          </button>
        </div>
        <div className="max-h-[60vh] overflow-y-auto no-scrollbar">
          {children}
        </div>
      </div>
    </div>
  );
};

// Enhanced Modal Contents
const SettingsContent = () => {
  const [darkTheme, setDarkTheme] = useState(false);
  
  return (
    <div className="space-y-2">
      <div className="px-1 py-1">
        <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-2">Preferences</h3>
        <div 
          onClick={() => setDarkTheme(!darkTheme)}
          className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer"
        >
          <div className="flex items-center gap-3">
            {darkTheme ? <Moon className="w-5 h-5 text-blue-600" /> : <Sun className="w-5 h-5 text-gray-600" />}
            <span className="text-gray-700">Dark theme</span>
          </div>
          <div className={`w-10 h-6 rounded-full relative transition-colors ${darkTheme ? 'bg-blue-600' : 'bg-gray-200'}`}>
            <div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow-sm transition-transform duration-200 ${darkTheme ? 'left-5' : 'left-1'}`} />
          </div>
        </div>

        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <Puzzle className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Extensions</span>
          </div>
          <ExternalLink className="w-4 h-4 text-gray-400" />
        </div>

        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <Globe className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Language</span>
          </div>
          <span className="text-sm text-gray-400">English (US)</span>
        </div>
      </div>

      <div className="border-t border-gray-200/50 my-2"></div>

      <div className="px-1 py-1">
        <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-2">Account</h3>
        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <Shield className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Public links</span>
          </div>
          <ExternalLink className="w-4 h-4 text-gray-400" />
        </div>
        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <CreditCard className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Subscription</span>
          </div>
        </div>
        <div className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <div className="flex items-center gap-3">
            <Bell className="w-5 h-5 text-gray-600" />
            <span className="text-gray-700">Notifications</span>
          </div>
        </div>
      </div>
    </div>
  );
};

const ActivityContent = () => (
  <div className="space-y-4">
    <div className="relative">
      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
      <input 
        type="text" 
        placeholder="Search your activity" 
        className="w-full bg-white/40 border-none rounded-full py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-blue-200 outline-none backdrop-blur-sm"
      />
    </div>

    <div>
      <div className="flex items-center justify-between mb-2">
        <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Today</p>
        <button className="text-xs text-blue-600 hover:underline">Clear day</button>
      </div>
      {[
        { title: "Explain React Hooks", time: "10:42 AM" },
        { title: "Draft an email to boss", time: "09:15 AM" }
      ].map((item, i) => (
        <div key={i} className="group flex items-start gap-3 p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <MessageSquare className="w-4 h-4 text-gray-400 mt-1 shrink-0" />
          <div className="flex-1 min-w-0">
            <p className="text-sm text-gray-800 truncate">{item.title}</p>
            <p className="text-xs text-gray-400 mt-0.5">{item.time} • Web</p>
          </div>
          <button className="opacity-0 group-hover:opacity-100 p-1 hover:bg-white/60 rounded-full text-gray-500 transition-all">
            <X className="w-3 h-3" />
          </button>
        </div>
      ))}
    </div>

    <div>
      <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Yesterday</p>
      {[
        { title: "Python script for data analysis", time: "4:20 PM" },
        { title: "Best sushi restaurants in Tokyo", time: "1:30 PM" }
      ].map((item, i) => (
        <div key={i} className="group flex items-start gap-3 p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer">
          <MessageSquare className="w-4 h-4 text-gray-400 mt-1 shrink-0" />
          <div className="flex-1 min-w-0">
            <p className="text-sm text-gray-800 truncate">{item.title}</p>
            <p className="text-xs text-gray-400 mt-0.5">{item.time} • Mobile</p>
          </div>
          <button className="opacity-0 group-hover:opacity-100 p-1 hover:bg-white/60 rounded-full text-gray-500 transition-all">
            <X className="w-3 h-3" />
          </button>
        </div>
      ))}
    </div>
  </div>
);

const HelpContent = () => (
  <div className="space-y-2">
    <div className="p-4 bg-blue-50/50 rounded-2xl mb-4 border border-blue-100/50">
      <h4 className="font-medium text-blue-800 mb-1">Gemini Advanced</h4>
      <p className="text-xs text-blue-600 mb-3">Get our most capable AI models and priority access to new features.</p>
      <button className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-full font-medium hover:bg-blue-700 transition-colors shadow-lg shadow-blue-600/20">
        Upgrade now
      </button>
    </div>

    {[
      { icon: HelpCircle, text: "Help Center" },
      { icon: Sparkles, text: "Updates & FAQ" },
      { icon: Keyboard, text: "Keyboard shortcuts" },
      { icon: FileQuestion, text: "Send feedback" },
      { icon: Info, text: "Privacy & Terms" }
    ].map((item, i) => (
      <div key={i} className="flex items-center justify-between p-3 hover:bg-white/40 rounded-xl transition-colors cursor-pointer group">
        <div className="flex items-center gap-3">
          <item.icon className="w-5 h-5 text-gray-500 group-hover:text-gray-700" />
          <span className="text-gray-700 group-hover:text-gray-900">{item.text}</span>
        </div>
        <ExternalLink className="w-4 h-4 text-gray-300 group-hover:text-gray-400" />
      </div>
    ))}
    
    <div className="mt-4 pt-4 border-t border-gray-200/50 text-center">
      <p className="text-xs text-gray-400">Version 2024.05.15</p>
    </div>
  </div>
);

// Individual Sidebar Chat Item Component
const SidebarItem = ({ chat, onLoad, onPin, onRename, onDelete, index }) => {
  const [isEditing, setIsEditing] = useState(false);
  const [editTitle, setEditTitle] = useState(chat.title);
  const [showMenu, setShowMenu] = useState(false);
  const inputRef = useRef(null);
  const menuRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (menuRef.current && !menuRef.current.contains(event.target)) {
        setShowMenu(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  const handleRenameSubmit = (e) => {
    e.preventDefault();
    if (editTitle.trim()) {
      onRename(chat.id, editTitle);
      setIsEditing(false);
      setShowMenu(false);
    }
  };

  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus();
    }
  }, [isEditing]);

  return (
    <div 
      className={`relative group animate-slide-in-left ${showMenu ? 'z-50' : 'z-auto'}`}
      style={{ animationDelay: `${(index + 1) * 50}ms` }}
    >
      {isEditing ? (
        <form onSubmit={handleRenameSubmit} className="px-2 py-1">
          <input
            ref={inputRef}
            type="text"
            value={editTitle}
            onChange={(e) => setEditTitle(e.target.value)}
            onBlur={() => { setIsEditing(false); setEditTitle(chat.title); }}
            className="w-full bg-white/50 border border-blue-500 rounded px-2 py-1 text-sm outline-none backdrop-blur-sm"
          />
        </form>
      ) : (
        <div 
          onClick={() => onLoad(chat.title)}
          className="w-full flex items-center justify-between hover:bg-white/40 px-4 py-2 rounded-full cursor-pointer transition-colors relative"
        >
          <div className="flex items-center gap-2 overflow-hidden flex-1">
            <span className={`text-sm text-gray-700 truncate ${chat.pinned ? 'font-medium' : ''}`}>{chat.title}</span>
            {chat.pinned && <Pin className="w-3.5 h-3.5 text-gray-400 fill-current shrink-0" />}
          </div>

          {/* Hover Menu Trigger */}
          <div className="opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 glass-darker pl-2 rounded-l-md">
            <button 
              onClick={(e) => { e.stopPropagation(); setShowMenu(!showMenu); }}
              className="p-1 hover:bg-gray-300/50 rounded-full text-gray-600"
            >
              <MoreHorizontal className="w-4 h-4" />
            </button>
          </div>
        </div>
      )}

      {/* Dropdown Menu - Glass Style */}
      {showMenu && !isEditing && (
        <div ref={menuRef} className="absolute right-0 top-8 z-50 w-36 glass-darker rounded-2xl shadow-xl py-1 flex flex-col animate-fade-in">
           <button 
            onClick={(e) => { e.stopPropagation(); onPin(chat.id); setShowMenu(false); }}
            className="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-white/40 w-full text-left"
          >
            <Pin className="w-4 h-4" />
            {chat.pinned ? 'Unpin' : 'Pin'}
          </button>
          <button 
            onClick={(e) => { e.stopPropagation(); setIsEditing(true); }}
            className="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-white/40 w-full text-left"
          >
            <Edit2 className="w-4 h-4" />
            Rename
          </button>
          <button 
            onClick={(e) => { e.stopPropagation(); onDelete(chat.id); setShowMenu(false); }}
            className="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50/50 w-full text-left"
          >
            <Trash2 className="w-4 h-4" />
            Delete
          </button>
        </div>
      )}
    </div>
  );
};

const Sidebar = ({ isOpen, toggleSidebar, onNewChat, onLoadRecent, onOpenModal, chatHistory, setChatHistory }) => {
  
  const handlePin = (id) => {
    setChatHistory(prev => prev.map(chat => 
      chat.id === id ? { ...chat, pinned: !chat.pinned } : chat
    ).sort((a, b) => (b.pinned === a.pinned ? 0 : b.pinned ? 1 : -1)));
  };

  const handleDelete = (id) => {
    setChatHistory(prev => prev.filter(chat => chat.id !== id));
  };

  const handleRename = (id, newTitle) => {
    setChatHistory(prev => prev.map(chat => 
      chat.id === id ? { ...chat, title: newTitle } : chat
    ));
  };

  // Sort: Pinned first
  const sortedChats = [...chatHistory].sort((a, b) => Number(b.pinned) - Number(a.pinned));

  return (
    <div 
      className={`
        fixed inset-y-0 left-0 z-50 glass-sidebar flex flex-col shadow-2xl 
        transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)]
        /* Mobile Behavior: Always 72 width, translate to hide/show */
        w-72 transform
        ${isOpen ? 'translate-x-0' : '-translate-x-full'}
        
        /* Desktop Behavior: Reset translate, animate width instead */
        lg:translate-x-0 lg:transform-none lg:shadow-none lg:relative
        ${isOpen ? 'lg:w-64 lg:opacity-100' : 'lg:w-0 lg:opacity-0 lg:overflow-hidden'}
      `}
    >
      {/* Inner container with NEW POP Animation on Open */}
      <div 
        className={`
          w-72 lg:w-64 flex flex-col h-full min-w-[16rem] 
          transition-all duration-500 ease-out
          ${isOpen ? 'opacity-100 translate-x-0 scale-100 delay-100' : 'opacity-0 -translate-x-4 scale-95'}
        `}
      >
        <div className="p-4 flex items-center justify-between">
          <button onClick={toggleSidebar} className="p-2 hover:bg-white/40 rounded-full transition-colors">
            <Menu className="w-5 h-5 text-gray-600" />
          </button>
        </div>

        <div className="px-4 py-2">
          <button 
            key={isOpen ? 'newchat-open' : 'newchat-closed'}
            onClick={onNewChat}
            className={`w-full flex items-center space-x-3 glass-card text-gray-700 hover:text-[#041E49] px-4 py-3 rounded-2xl transition-all duration-200 whitespace-nowrap ${isOpen ? 'animate-pop delay-100' : ''}`}
          >
            <Plus className="w-5 h-5 shrink-0" />
            <span className="font-medium text-sm">New chat</span>
          </button>
        </div>

        <div className="flex-1 overflow-y-auto px-2 py-4 no-scrollbar">
          <div key={`recent-label-${isOpen}`} className={`text-xs font-medium text-gray-500 px-4 mb-2 ${isOpen ? 'animate-fade-in delay-200' : ''}`}>Recent</div>
          <div className="space-y-1 pb-10">
            {sortedChats.map((chat, idx) => (
              <SidebarItem 
                key={`${chat.id}-${isOpen}`}
                index={idx}
                chat={chat}
                onLoad={onLoadRecent}
                onPin={handlePin}
                onDelete={handleDelete}
                onRename={handleRename}
              />
            ))}
            {sortedChats.length === 0 && (
              <div className="px-4 text-sm text-gray-400 italic">No recent chats</div>
            )}
          </div>
        </div>

        <div className="p-2 mt-auto border-t border-white/20">
          <button 
            onClick={() => onOpenModal('help')}
            className="w-full flex items-center space-x-3 hover:bg-white/40 px-4 py-2.5 rounded-full text-left transition-colors whitespace-nowrap"
          >
            <HelpCircle className="w-5 h-5 text-gray-600 shrink-0" />
            <span className="text-sm text-gray-700">Help</span>
          </button>
          <button 
            onClick={() => onOpenModal('activity')}
            className="w-full flex items-center space-x-3 hover:bg-white/40 px-4 py-2.5 rounded-full text-left transition-colors whitespace-nowrap"
          >
            <Activity className="w-5 h-5 text-gray-600 shrink-0" />
            <span className="text-sm text-gray-700">Activity</span>
          </button>
          <button 
            onClick={() => onOpenModal('settings')}
            className="w-full flex items-center space-x-3 hover:bg-white/40 px-4 py-2.5 rounded-full text-left transition-colors whitespace-nowrap"
          >
            <Settings className="w-5 h-5 text-gray-600 shrink-0" />
            <span className="text-sm text-gray-700">Settings</span>
          </button>
        </div>
      </div>
    </div>
  );
};

// Updated UserMessage with slide-in from left - Glassy Style
const UserMessage = ({ content, delay = 0 }) => (
  <div 
    className="flex justify-end mb-8 animate-message-slide-in"
    style={{ animationDelay: `${delay}ms` }}
  >
    <div className="glass-bubble-user text-[#1F1F1F] px-5 py-3 rounded-2xl rounded-tr-sm max-w-[80%] md:max-w-[70%] leading-relaxed whitespace-pre-wrap shadow-sm">
      {content}
    </div>
  </div>
);

// Updated AIMessage with slide-in from left
const AIMessage = ({ content, isTyping, onShowToast, delay = 0 }) => {
  const [liked, setLiked] = useState(false);
  const [disliked, setDisliked] = useState(false);

  const handleCopy = () => {
    try {
      // Use document.execCommand for iframe compatibility
      const textArea = document.createElement("textarea");
      textArea.value = content;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      onShowToast("Response copied to clipboard");
    } catch (e) {
      onShowToast("Failed to copy");
    }
  };

  const handleLike = () => {
    setLiked(!liked);
    setDisliked(false);
    if (!liked) onShowToast("Thanks for the feedback!");
  };

  const handleDislike = () => {
    setDisliked(!disliked);
    setLiked(false);
    if (!disliked) onShowToast("Thanks for the feedback!");
  };

  return (
    <div 
      className="flex items-start space-x-4 mb-8 group animate-message-slide-in"
      style={{ animationDelay: `${delay}ms` }}
    >
      <div className="flex-shrink-0 mt-1">
        <div className="w-8 h-8 rounded-full overflow-hidden flex items-center justify-center bg-gradient-to-tr from-[#4285F4] to-[#9B72CB] shadow-md">
          <Sparkles className="w-5 h-5 text-white animate-pulse" />
        </div>
      </div>
      <div className="flex-1 space-y-2">
        <div className="font-medium text-sm text-gray-900">Gemini</div>
        <div className="prose prose-slate max-w-none text-[#1F1F1F] leading-7 fade-in-text whitespace-pre-wrap">
          {content}
          {isTyping && <span className="inline-block w-2 h-4 bg-gray-400 ml-1 animate-pulse"></span>}
        </div>
        
        {!isTyping && (
          <div className="flex items-center space-x-1 pt-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
            <button 
              onClick={handleLike}
              className={`p-1.5 hover:bg-white/50 rounded-full transition-colors ${liked ? 'text-blue-600' : 'text-gray-500'}`} 
              title="Good response"
            >
              <ThumbsUp className={`w-4 h-4 ${liked ? 'fill-current' : ''}`} />
            </button>
            <button 
              onClick={handleDislike}
              className={`p-1.5 hover:bg-white/50 rounded-full transition-colors ${disliked ? 'text-red-500' : 'text-gray-500'}`}
            >
              <ThumbsDown className={`w-4 h-4 ${disliked ? 'fill-current' : ''}`} />
            </button>
            <button 
              onClick={handleCopy}
              className="p-1.5 hover:bg-white/50 rounded-full text-gray-500 transition-colors"
              title="Copy"
            >
              <Copy className="w-4 h-4" />
            </button>
            <button className="p-1.5 hover:bg-white/50 rounded-full text-gray-500 transition-colors" title="Regenerate">
              <RotateCcw className="w-4 h-4" />
            </button>
            <button className="p-1.5 hover:bg-white/50 rounded-full text-gray-500 transition-colors">
              <MoreVertical className="w-4 h-4" />
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default function App() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const [isTyping, setIsTyping] = useState(false);
  const [toastMsg, setToastMsg] = useState('');
  const [isListening, setIsListening] = useState(false);
  const [activeModal, setActiveModal] = useState(null);
  const [conversationId, setConversationId] = useState(0); 
  
  // Chat History State
  const [chatHistory, setChatHistory] = useState([
    { id: 1, title: "React UI Design Patterns", pinned: false },
    { id: 2, title: "Material 3 Specifications", pinned: true },
    { id: 3, title: "Tailwind Animation Guide", pinned: false },
    { id: 4, title: "Frontend Architecture", pinned: false },
    { id: 5, title: "Understanding CSS Grid", pinned: false },
    { id: 6, title: "Next.js vs Remix", pinned: false },
  ]);

  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);
  const fileInputRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isTyping]);

  const showToast = (msg) => {
    setToastMsg(msg);
  };

  const handleSend = async (text = input) => {
    if (!text.trim()) return;

    const userMsg = {
      id: Date.now(),
      role: 'user',
      content: text
    };

    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsTyping(true);

    // Call Gemini API
    try {
      const apiKey = ""; // Will be injected by runtime
      
      // Prepare messages for context, mapping internal role to API role
      const history = messages.map(msg => ({
        role: msg.role === 'user' ? 'user' : 'model',
        parts: [{ text: msg.content }]
      }));

      // Add current message to the payload
      const apiContents = [
        ...history,
        { role: 'user', parts: [{ text: text }] }
      ];

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: apiContents,
            // You can add system instructions here if needed
          })
        }
      );

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = await response.json();
      const aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";

      const aiMsg = {
        id: Date.now() + 1,
        role: 'ai',
        content: aiResponseText
      };
      
      setMessages(prev => [...prev, aiMsg]);

    } catch (error) {
      console.error("Gemini API Error:", error);
      showToast("Error connecting to Gemini API");
      
      // Add error message to chat for visibility
      const errorMsg = {
        id: Date.now() + 1,
        role: 'ai',
        content: "I'm sorry, I'm having trouble connecting to my brain right now. Please try again later."
      };
      setMessages(prev => [...prev, errorMsg]);
    } finally {
      setIsTyping(false);
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const handleNewChat = () => {
    setMessages([]); 
    setIsTyping(false);
    setInput('');
    setConversationId(Date.now()); // Trigger new animation
    if (window.innerWidth < 1024) setIsSidebarOpen(false);
  };

  const handleLoadRecent = (topic) => {
    setIsTyping(false);
    setConversationId(Date.now()); // Trigger new animation
    setMessages([
      { id: 1, role: 'user', content: `Tell me about ${topic}` },
      { id: 2, role: 'ai', content: `Here is the retrieved information regarding **${topic}**. \n\nIt seems we discussed this yesterday. The key takeaways were:\n- Simplicity is key\n- Use consistent spacing\n\nDo you want to continue this conversation?` }
    ]);
    if (window.innerWidth < 1024) setIsSidebarOpen(false);
  };

  const handleSuggestionClick = (suggestion) => {
    handleSend(suggestion);
  };

  const handleFileUpload = (e) => {
    if (e.target.files && e.target.files[0]) {
      showToast(`Image "${e.target.files[0].name}" attached`);
    }
  };

  const toggleMic = () => {
    if (!isListening) {
      setIsListening(true);
      showToast("Listening...");
      setTimeout(() => {
        setIsListening(false);
        setInput("How do I build a spaceship?");
      }, 2000);
    } else {
      setIsListening(false);
    }
  };

  const renderModalContent = () => {
    switch (activeModal) {
      case 'settings': return <SettingsContent />;
      case 'activity': return <ActivityContent />;
      case 'help': return <HelpContent />;
      default: return null;
    }
  };

  const getModalTitle = () => {
    switch (activeModal) {
      case 'settings': return 'Settings';
      case 'activity': return 'Gemini Activity';
      case 'help': return 'Help';
      default: return '';
    }
  };

  return (
    <div className="relative flex h-screen font-sans overflow-hidden text-[#1F1F1F] selection:bg-[#c2dbfe] selection:text-[#0b57d0] bg-[#F8F9FA]">
      <style>{customStyles}</style>

      {/* Moved Blobs to global background so sidebar can be transparent */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none z-0 opacity-40">
        <div className="absolute top-0 left-1/4 w-[800px] h-[800px] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div className="absolute top-0 right-1/4 w-[800px] h-[800px] bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        <div className="absolute -bottom-8 left-1/3 w-[800px] h-[800px] bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
      </div>

      <Toast message={toastMsg} onClose={() => setToastMsg('')} />

      <Modal 
        isOpen={!!activeModal} 
        onClose={() => setActiveModal(null)} 
        title={getModalTitle()}
      >
        {renderModalContent()}
      </Modal>

      <Sidebar 
        isOpen={isSidebarOpen} 
        toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)} 
        onNewChat={handleNewChat}
        onLoadRecent={handleLoadRecent}
        onOpenModal={setActiveModal}
        chatHistory={chatHistory}
        setChatHistory={setChatHistory}
      />

      <div className="flex-1 flex flex-col h-full relative z-10">
        
        <div className="flex items-center justify-between px-5 py-3">
          <div className="flex items-center space-x-2">
            {!isSidebarOpen && (
              <button onClick={() => setIsSidebarOpen(true)} className="p-2 hover:bg-white/50 rounded-full transition-colors mr-2">
                <Menu className="w-5 h-5 text-gray-600" />
              </button>
            )}
            
            {/* NEW: Persistent New Chat Icon Button - Glassy */}
            <button 
              onClick={handleNewChat}
              className="p-2 hover:bg-white/50 rounded-full transition-colors mr-2 text-gray-600"
              title="New Chat"
            >
              <SquarePen className="w-5 h-5" />
            </button>

            <button className="flex items-center space-x-1 text-lg font-medium text-gray-600 hover:bg-white/50 px-3 py-1.5 rounded-lg transition-colors">
              <span>Gemini</span>
              <span className="text-xs text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-500 font-bold">Advanced</span>
              <MoreVertical className="w-4 h-4 ml-1" />
            </button>
          </div>
          <div className="flex items-center space-x-2">
             <button 
                onClick={() => setActiveModal('settings')}
                className="p-2 hover:bg-white/50 rounded-full transition-colors hidden sm:block"
             >
                <Settings className="w-5 h-5 text-gray-600" />
             </button>
             <div className="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm font-medium cursor-pointer hover:ring-4 hover:ring-purple-100 transition-all shadow-lg shadow-purple-200">U</div>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto relative no-scrollbar">
          
          {/* Add key here to force re-render and trigger animation on conversation switch */}
          <div key={conversationId} className="max-w-[800px] mx-auto px-4 pb-32 pt-10">
            {messages.length === 0 ? (
               <div className="flex flex-col items-center justify-center min-h-[50vh] text-center animate-pop">
                  <div className="mb-10 mt-10">
                    <span className="text-5xl font-medium bg-clip-text text-transparent bg-gradient-to-r from-[#4285F4] to-[#9B72CB]">
                      Hello, User
                    </span>
                    <br />
                    <span className="text-5xl font-medium text-[#939699]">
                      How can I help today?
                    </span>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 w-full max-w-4xl px-4">
                     {[
                        { text: 'Explain React Hooks', icon: Code },
                        { text: 'Plan a trip to Japan', icon: Send },
                        { text: 'Write a SQL Query', icon: Code },
                        { text: 'Draft an email', icon: Sparkles }
                     ].map((item, i) => (
                       <button 
                        key={i} 
                        onClick={() => handleSuggestionClick(item.text)}
                        className={`glass-card p-4 rounded-3xl text-left h-40 flex flex-col justify-between relative overflow-hidden group animate-pop delay-${(i+1)*100}`}
                      >
                          <span className="text-sm font-medium text-gray-700 z-10">{item.text}</span>
                          <div className="self-end p-2 bg-white/50 rounded-full shadow-sm group-hover:shadow-md transition-shadow z-10 backdrop-blur-sm">
                            <item.icon className="w-4 h-4 text-gray-600 group-hover:text-blue-500" />
                          </div>
                       </button>
                     ))}
                  </div>
               </div>
            ) : (
              messages.map((msg, index) => (
                msg.role === 'user' ? 
                <UserMessage key={msg.id} content={msg.content} delay={index * 100} /> : 
                <AIMessage 
                  key={msg.id} 
                  content={msg.content} 
                  isTyping={isTyping && msg.id === messages[messages.length-1].id} 
                  onShowToast={showToast} 
                  delay={index * 100}
                />
              ))
            )}
            <div ref={messagesEndRef} />
          </div>
        </div>

        <div className="absolute bottom-0 left-0 right-0 pt-10 pb-6 bg-gradient-to-t from-[#F8F9FA]/80 via-[#F8F9FA]/40 to-transparent pointer-events-none">
          <div className="max-w-[800px] mx-auto px-4 pointer-events-auto">
            <div className={`
              relative flex items-end gap-2 p-3 rounded-[32px] transition-all duration-300
              glass-input
            `}>
              
              <input 
                type="file" 
                ref={fileInputRef} 
                className="hidden" 
                onChange={handleFileUpload} 
                accept="image/*"
              />
              <button 
                onClick={() => fileInputRef.current?.click()}
                className="p-2 text-gray-600 hover:bg-gray-100/50 rounded-full transition-colors mb-0.5 tooltip"
                title="Upload image"
              >
                <ImageIcon className="w-6 h-6" />
              </button>

              <textarea
                ref={inputRef}
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Enter a prompt here"
                className="w-full bg-transparent border-none outline-none resize-none text-base py-3 max-h-32 text-gray-800 placeholder-gray-500"
                rows={1}
                style={{ minHeight: '48px' }}
              />

              <div className="flex items-center gap-1 mb-0.5">
                {input ? (
                   <button 
                    onClick={() => handleSend()}
                    className="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-colors animate-pop shadow-lg shadow-blue-500/30"
                  >
                    <Send className="w-5 h-5" />
                  </button>
                ) : (
                  <button 
                    onClick={toggleMic}
                    className={`p-2 rounded-full transition-colors ${isListening ? 'bg-red-100 text-red-600' : 'text-gray-600 hover:bg-gray-100/50'}`}
                  >
                    <Mic className={`w-6 h-6 ${isListening ? 'animate-pulse' : ''}`} />
                  </button>
                )}
              </div>
            </div>
            
            <div className="text-center mt-3">
              <p className="text-xs text-gray-500">
                Gemini may display inaccurate info, including about people, so double-check its responses. 
                <a href="#" className="underline ml-1">Your privacy and Gemini Apps</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
